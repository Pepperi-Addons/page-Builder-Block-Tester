import { Component, Input, Output, EventEmitter, } from '@angular/core';
import { trigger, state, style, transition, animate, } from '@angular/animations';
import { PepLayoutService, PepScreenSizeType, } from '@pepperi-addons/ngx-lib';
import { pepIconSystemMenu } from '@pepperi-addons/ngx-lib/icon';
import { PepMenuItemParent, } from './menu.model';
export class PepMenuComponent {
    constructor(layoutService) {
        this.layoutService = layoutService;
        this.text = null;
        /**
         * The icon name to show on the menu. look in (@link icon -> All icons)
         *
         * @type {PepIconType} See {@link PepIconType}
         * @memberof PepMenuComponent
         */
        this.iconName = pepIconSystemMenu.name;
        this.type = 'action';
        this.styleType = 'weak';
        this.sizeType = 'md';
        this.classNames = '';
        this.xPosition = 'after';
        this.hideOnEmptyItems = false;
        this._items = null;
        this.selectedItem = null;
        this.disabled = false;
        this.stateChange = new EventEmitter();
        this.menuItemClick = new EventEmitter();
        this.menuClick = new EventEmitter();
        this.state = 'hidden';
        this.PepScreenSizeType = PepScreenSizeType;
        this.displayText = null;
        this.layoutService.onResize$.subscribe((size) => {
            this.screenSize = size;
        });
    }
    set items(items) {
        this.setItemsParent(items);
        this._items = items;
    }
    get items() {
        return this._items;
    }
    setChildrenParent(item, parent) {
        item.parent = parent;
        if (item.children && item.children.length > 0) {
            item.children.forEach((child) => {
                this.setChildrenParent(child, new PepMenuItemParent(item));
            });
        }
    }
    setItemsParent(items) {
        if (items) {
            items.forEach((item) => {
                item.parent = null;
                if (item.children && item.children.length > 0) {
                    item.children.forEach((child) => {
                        this.setChildrenParent(child, new PepMenuItemParent(item));
                    });
                }
            });
        }
    }
    updateText() {
        if (this.type === 'select' || this.type === 'action-select') {
            this.displayText = this.selectedItem
                ? this.selectedItem.text
                : this.text;
        }
        else {
            this.displayText = this.text;
        }
    }
    ngOnChanges(changes) {
        if (this.hideOnEmptyItems) {
            this.state =
                !this.disabled &&
                    this.items &&
                    this.items.filter((item) => !item.disabled).length > 0
                    ? 'visible'
                    : 'hidden';
        }
        else {
            this.state = 'visible';
        }
        if (this.type === 'select') {
            if (this.selectedItem === null &&
                this.items &&
                this.items.length > 0) {
                this.selectedItem = this.items[0];
            }
        }
        this.updateText();
    }
    ngOnDestroy() {
        // if (this.menuItemClick) {
        //     this.menuItemClick.unsubscribe();
        // }
    }
    onMenuClicked(event) {
        this.menuClick.emit();
    }
    // private manipulateData(menuItem: PepMenuItem) {
    //     menuItem.children = null;
    //     if (menuItem.parent) {
    //         menuItem.parent = new PepMenuItem(menuItem.parent);
    //         this.manipulateData(menuItem.parent);
    //     }
    // }
    onMenuItemClicked(click) {
        this.selectedItem = click.source;
        this.updateText();
        // Manipulate click data because the data is dupplicate in parent.children
        // const tmp = new PepMenuItem(click.source);
        // this.manipulateData(tmp);
        // click.source = tmp;
        this.menuItemClick.emit(click);
    }
    animationDone() {
        if (this.state === 'hidden') {
            setTimeout(() => {
                this.stateChange.emit({ state: this.state });
            }, 500);
        }
    }
    animationStart() {
        if (this.state === 'visible') {
            this.stateChange.emit({ state: this.state });
        }
    }
}
PepMenuComponent.decorators = [
    { type: Component, args: [{
                selector: 'pep-menu',
                template: "<div class=\"menu-container\" dir=\"{{ layoutService.isRtl() ? 'rtl' : 'ltr' }}\">\n\n    <ng-container *ngIf=\"hideOnEmptyItems then animationTemplate else regularTemplate\">\n    </ng-container>\n    <ng-template #animationTemplate>\n        <button mat-button class=\"pep-button {{ sizeType }} {{ styleType }} {{ classNames }}\"\n            [ngClass]=\"{ 'icon-button': !displayText || screenSize > PepScreenSizeType.SM, 'pep-button-limited-width': screenSize < PepScreenSizeType.XS  }\"\n            pepRtlDirection pepMenuBlur (click)=\"onMenuClicked($event)\" [@slideInOut]=\"state\"\n            (@slideInOut.done)=\"animationDone()\" (@slideInOut.start)=\"animationStart()\"\n            [matMenuTriggerFor]=\"menu.childMenu\">\n            <ng-container *ngTemplateOutlet=\"triggerTemplate\">\n            </ng-container>\n        </button>\n        <pep-menu-item #menu [type]=\"type\" [items]=\"items\" [selectedItem]=\"selectedItem\" [xPosition]=\"xPosition\"\n            (menuItemClick)=\"onMenuItemClicked($event)\">\n        </pep-menu-item>\n    </ng-template>\n    <ng-template #regularTemplate>\n        <ng-container *ngIf=\"items then menuTemplate else buttonTemplate\"></ng-container>\n        <ng-template #menuTemplate>\n            <button mat-button class=\"pep-button {{ sizeType }} {{ styleType }} {{ classNames }}\"\n                [ngClass]=\"{ 'icon-button': !displayText || screenSize > PepScreenSizeType.SM, 'pep-button-limited-width': screenSize < PepScreenSizeType.XS, disabled: disabled }\"\n                pepRtlDirection pepMenuBlur (menuClick)=\"onMenuClicked($event)\" [disabled]=\"disabled\"\n                [matMenuTriggerFor]=\"menu.childMenu\">\n                <ng-container *ngTemplateOutlet=\"triggerTemplate\">\n                </ng-container>\n            </button>\n            <pep-menu-item #menu [type]=\"type\" [items]=\"items\" [selectedItem]=\"selectedItem\" [xPosition]=\"xPosition\"\n                (menuItemClick)=\"onMenuItemClicked($event)\"></pep-menu-item>\n        </ng-template>\n        <ng-template #buttonTemplate>\n            <button mat-button class=\"pep-button {{ sizeType }} {{ styleType }} {{ classNames }}\"\n                [ngClass]=\"{ 'icon-button': !displayText || screenSize > PepScreenSizeType.SM, 'pep-button-limited-width': screenSize < PepScreenSizeType.XS, disabled: disabled }\"\n                pepRtlDirection pepMenuBlur (menuClick)=\"onMenuClicked($event)\" [disabled]=\"disabled\">\n                <ng-container *ngTemplateOutlet=\"triggerTemplate\">\n                </ng-container>\n            </button>\n        </ng-template>\n    </ng-template>\n</div>\n\n<ng-template #triggerTemplate>\n    <span *ngIf=\"displayText && screenSize <= PepScreenSizeType.SM\" class=\"ellipsis\"\n        [ngClass]=\"{ 'button-title-with-icon': iconName }\" [title]=\"displayText\">\n        {{ displayText }}\n    </span>\n    <mat-icon *ngIf=\"iconName\">\n        <pep-icon name=\"{{ iconName }}\"></pep-icon>\n    </mat-icon>\n</ng-template>",
                animations: [
                    trigger('slideInOut', [
                        state('hidden', style({
                            width: '0px',
                            padding: '0',
                            margin: '0',
                            minWidth: '0px',
                            opacity: 0,
                        })),
                        state('visible', style({
                            width: 'inherit',
                            opacity: 1,
                        })),
                        transition('close => open', animate('500ms ease-in')),
                        transition('open => close', animate('500ms ease-out')),
                    ]),
                ],
                styles: [".menu-container .pep-button{display:flex;align-items:center;justify-content:center}"]
            },] }
];
PepMenuComponent.ctorParameters = () => [
    { type: PepLayoutService }
];
PepMenuComponent.propDecorators = {
    text: [{ type: Input }],
    iconName: [{ type: Input }],
    type: [{ type: Input }],
    styleType: [{ type: Input }],
    sizeType: [{ type: Input }],
    classNames: [{ type: Input }],
    xPosition: [{ type: Input }],
    hideOnEmptyItems: [{ type: Input }],
    items: [{ type: Input }],
    selectedItem: [{ type: Input }],
    disabled: [{ type: Input }],
    stateChange: [{ type: Output }],
    menuItemClick: [{ type: Output }],
    menuClick: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtbGliL21lbnUvbWVudS5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUNILFNBQVMsRUFDVCxLQUFLLEVBQ0wsTUFBTSxFQUNOLFlBQVksR0FHZixNQUFNLGVBQWUsQ0FBQztBQUN2QixPQUFPLEVBQ0gsT0FBTyxFQUNQLEtBQUssRUFDTCxLQUFLLEVBQ0wsVUFBVSxFQUNWLE9BQU8sR0FDVixNQUFNLHFCQUFxQixDQUFDO0FBQzdCLE9BQU8sRUFDSCxnQkFBZ0IsRUFHaEIsaUJBQWlCLEdBQ3BCLE1BQU0seUJBQXlCLENBQUM7QUFDakMsT0FBTyxFQUFFLGlCQUFpQixFQUFlLE1BQU0sOEJBQThCLENBQUM7QUFDOUUsT0FBTyxFQU1ILGlCQUFpQixHQUNwQixNQUFNLGNBQWMsQ0FBQztBQThCdEIsTUFBTSxPQUFPLGdCQUFnQjtJQTBDekIsWUFBbUIsYUFBK0I7UUFBL0Isa0JBQWEsR0FBYixhQUFhLENBQWtCO1FBekN6QyxTQUFJLEdBQVcsSUFBSSxDQUFDO1FBQzdCOzs7OztXQUtHO1FBQ00sYUFBUSxHQUFnQixpQkFBaUIsQ0FBQyxJQUFJLENBQUM7UUFDL0MsU0FBSSxHQUFnQixRQUFRLENBQUM7UUFDN0IsY0FBUyxHQUFpQixNQUFNLENBQUM7UUFDakMsYUFBUSxHQUFnQixJQUFJLENBQUM7UUFDN0IsZUFBVSxHQUFHLEVBQUUsQ0FBQztRQUNoQixjQUFTLEdBQXVCLE9BQU8sQ0FBQztRQUN4QyxxQkFBZ0IsR0FBRyxLQUFLLENBQUM7UUFFMUIsV0FBTSxHQUF1QixJQUFJLENBQUM7UUFVakMsaUJBQVksR0FBZ0IsSUFBSSxDQUFDO1FBQ2pDLGFBQVEsR0FBRyxLQUFLLENBQUM7UUFHMUIsZ0JBQVcsR0FBMkMsSUFBSSxZQUFZLEVBQTRCLENBQUM7UUFFbkcsa0JBQWEsR0FBeUMsSUFB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QUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1NBQ2hEO0lBQ0wsQ0FBQzs7O1lBeExKLFNBQVMsU0FBQztnQkFDUCxRQUFRLEVBQUUsVUFBVTtnQkFDcEIsbStGQUFvQztnQkFFcEMsVUFBVSxFQUFFO29CQUNSLE9BQU8sQ0FBQyxZQUFZLEVBQUU7d0JBQ2xCLEtBQUssQ0FDRCxRQUFRLEVBQ1IsS0FBSyxDQUFDOzRCQUNGLEtBQUssRUFBRSxLQUFLOzRCQUNaLE9BQU8sRUFBRSxHQUFHOzRCQUNaLE1BQU0sRUFBRSxHQUFHOzRCQUNYLFFBQVEsRUFBRSxLQUFLOzRCQUNmLE9BQU8sRUFBRSxDQUFDO3lCQUNiLENBQUMsQ0FDTDt3QkFDRCxLQUFLLENBQ0QsU0FBUyxFQUNULEtBQUssQ0FBQzs0QkFDRixLQUFLLEVBQUUsU0FBUzs0QkFDaEIsT0FBTyxFQUFFLENBQUM7eUJBQ2IsQ0FBQyxDQUNMO3dCQUNELFVBQVUsQ0FBQyxlQUFlLEVBQUUsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO3dCQUNyRCxVQUFVLENBQUMsZUFBZSxFQUFFLE9BQU8sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO3FCQUN6RCxDQUFDO2lCQUNMOzthQUNKOzs7WUExQ0csZ0JBQWdCOzs7bUJBNENmLEtBQUs7dUJBT0wsS0FBSzttQkFDTCxLQUFLO3dCQUNMLEtBQUs7dUJBQ0wsS0FBSzt5QkFDTCxLQUFLO3dCQUNMLEtBQUs7K0JBQ0wsS0FBSztvQkFHTCxLQUFLOzJCQVNMLEtBQUs7dUJBQ0wsS0FBSzswQkFFTCxNQUFNOzRCQUVOLE1BQU07d0JBRU4sTUFBTSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgQ29tcG9uZW50LFxuICAgIElucHV0LFxuICAgIE91dHB1dCxcbiAgICBFdmVudEVtaXR0ZXIsXG4gICAgT25DaGFuZ2VzLFxuICAgIE9uRGVzdHJveSxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICAgIHRyaWdnZXIsXG4gICAgc3RhdGUsXG4gICAgc3R5bGUsXG4gICAgdHJhbnNpdGlvbixcbiAgICBhbmltYXRlLFxufSBmcm9tICdAYW5ndWxhci9hbmltYXRpb25zJztcbmltcG9ydCB7XG4gICAgUGVwTGF5b3V0U2VydmljZSxcbiAgICBQZXBTdHlsZVR5cGUsXG4gICAgUGVwU2l6ZVR5cGUsXG4gICAgUGVwU2NyZWVuU2l6ZVR5cGUsXG59IGZyb20gJ0BwZXBwZXJpLWFkZG9ucy9uZ3gtbGliJztcbmltcG9ydCB7IHBlcEljb25TeXN0ZW1NZW51LCBQZXBJY29uVHlwZSB9IGZyb20gJ0BwZXBwZXJpLWFkZG9ucy9uZ3gtbGliL2ljb24nO1xuaW1wb3J0IHtcbiAgICBQZXBNZW51SXRlbSxcbiAgICBJUGVwTWVudUl0ZW1DbGlja0V2ZW50LFxuICAgIElQZXBNZW51U3RhdGVDaGFuZ2VFdmVudCxcbiAgICBQZXBNZW51U3RhdGVUeXBlLFxuICAgIFBlcE1lbnVUeXBlLFxuICAgIFBlcE1lbnVJdGVtUGFyZW50LFxufSBmcm9tICcuL21lbnUubW9kZWwnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogJ3BlcC1tZW51JyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vbWVudS5jb21wb25lbnQuaHRtbCcsXG4gICAgc3R5bGVVcmxzOiBbJy4vbWVudS5jb21wb25lbnQuc2NzcyddLFxuICAgIGFuaW1hdGlvbnM6IFtcbiAgICAgICAgdHJpZ2dlcignc2xpZGVJbk91dCcsIFtcbiAgICAgICAgICAgIHN0YXRlKFxuICAgICAgICAgICAgICAgICdoaWRkZW4nLFxuICAgICAgICAgICAgICAgIHN0eWxlKHtcbiAgICAgICAgICAgICAgICAgICAgd2lkdGg6ICcwcHgnLFxuICAgICAgICAgICAgICAgICAgICBwYWRkaW5nOiAnMCcsXG4gICAgICAgICAgICAgICAgICAgIG1hcmdpbjogJzAnLFxuICAgICAgICAgICAgICAgICAgICBtaW5XaWR0aDogJzBweCcsXG4gICAgICAgICAgICAgICAgICAgIG9wYWNpdHk6IDAsXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBzdGF0ZShcbiAgICAgICAgICAgICAgICAndmlzaWJsZScsXG4gICAgICAgICAgICAgICAgc3R5bGUoe1xuICAgICAgICAgICAgICAgICAgICB3aWR0aDogJ2luaGVyaXQnLFxuICAgICAgICAgICAgICAgICAgICBvcGFjaXR5OiAxLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApLFxuICAgICAgICAgICAgdHJhbnNpdGlvbignY2xvc2UgPT4gb3BlbicsIGFuaW1hdGUoJzUwMG1zIGVhc2UtaW4nKSksXG4gICAgICAgICAgICB0cmFuc2l0aW9uKCdvcGVuID0+IGNsb3NlJywgYW5pbWF0ZSgnNTAwbXMgZWFzZS1vdXQnKSksXG4gICAgICAgIF0pLFxuICAgIF0sXG59KVxuZXhwb3J0IGNsYXNzIFBlcE1lbnVDb21wb25lbnQgaW1wbGVtZW50cyBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gICAgQElucHV0KCkgdGV4dDogc3RyaW5nID0gbnVsbDtcbiAgICAvKipcbiAgICAgKiBUaGUgaWNvbiBuYW1lIHRvIHNob3cgb24gdGhlIG1lbnUuIGxvb2sgaW4gKEBsaW5rIGljb24gLT4gQWxsIGljb25zKVxuICAgICAqXG4gICAgICogQHR5cGUge1BlcEljb25UeXBlfSBTZWUge0BsaW5rIFBlcEljb25UeXBlfVxuICAgICAqIEBtZW1iZXJvZiBQZXBNZW51Q29tcG9uZW50XG4gICAgICovXG4gICAgQElucHV0KCkgaWNvbk5hbWU6IFBlcEljb25UeXBlID0gcGVwSWNvblN5c3RlbU1lbnUubmFtZTtcbiAgICBASW5wdXQoKSB0eXBlOiBQZXBNZW51VHlwZSA9ICdhY3Rpb24nO1xuICAgIEBJbnB1dCgpIHN0eWxlVHlwZTogUGVwU3R5bGVUeXBlID0gJ3dlYWsnO1xuICAgIEBJbnB1dCgpIHNpemVUeXBlOiBQZXBTaXplVHlwZSA9ICdtZCc7XG4gICAgQElucHV0KCkgY2xhc3NOYW1lcyA9ICcnO1xuICAgIEBJbnB1dCgpIHhQb3NpdGlvbjogJ2JlZm9yZScgfCAnYWZ0ZXInID0gJ2FmdGVyJztcbiAgICBASW5wdXQoKSBoaWRlT25FbXB0eUl0ZW1zID0gZmFsc2U7XG5cbiAgICBwcml2YXRlIF9pdGVtczogQXJyYXk8UGVwTWVudUl0ZW0+ID0gbnVsbDtcbiAgICBASW5wdXQoKVxuICAgIHNldCBpdGVtcyhpdGVtczogQXJyYXk8UGVwTWVudUl0ZW0+KSB7XG4gICAgICAgIHRoaXMuc2V0SXRlbXNQYXJlbnQoaXRlbXMpO1xuICAgICAgICB0aGlzLl9pdGVtcyA9IGl0ZW1zO1xuICAgIH1cbiAgICBnZXQgaXRlbXMoKTogQXJyYXk8UGVwTWVudUl0ZW0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2l0ZW1zO1xuICAgIH1cblxuICAgIEBJbnB1dCgpIHNlbGVjdGVkSXRlbTogUGVwTWVudUl0ZW0gPSBudWxsO1xuICAgIEBJbnB1dCgpIGRpc2FibGVkID0gZmFsc2U7XG5cbiAgICBAT3V0cHV0KClcbiAgICBzdGF0ZUNoYW5nZTogRXZlbnRFbWl0dGVyPElQZXBNZW51U3RhdGVDaGFuZ2VFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyPElQZXBNZW51U3RhdGVDaGFuZ2VFdmVudD4oKTtcbiAgICBAT3V0cHV0KClcbiAgICBtZW51SXRlbUNsaWNrOiBFdmVudEVtaXR0ZXI8SVBlcE1lbnVJdGVtQ2xpY2tFdmVudD4gPSBuZXcgRXZlbnRFbWl0dGVyPElQZXBNZW51SXRlbUNsaWNrRXZlbnQ+KCk7XG4gICAgQE91dHB1dCgpIG1lbnVDbGljazogRXZlbnRFbWl0dGVyPHZvaWQ+ID0gbmV3IEV2ZW50RW1pdHRlcjx2b2lkPigpO1xuXG4gICAgc3RhdGU6IFBlcE1lbnVTdGF0ZVR5cGUgPSAnaGlkZGVuJztcblxuICAgIFBlcFNjcmVlblNpemVUeXBlID0gUGVwU2NyZWVuU2l6ZVR5cGU7XG4gICAgc2NyZWVuU2l6ZTogUGVwU2NyZWVuU2l6ZVR5cGU7XG5cbiAgICBkaXNwbGF5VGV4dDogc3RyaW5nID0gbnVsbDtcblxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBsYXlvdXRTZXJ2aWNlOiBQZXBMYXlvdXRTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMubGF5b3V0U2VydmljZS5vblJlc2l6ZSQuc3Vic2NyaWJlKChzaXplKSA9PiB7XG4gICAgICAgICAgICB0aGlzLnNjcmVlblNpemUgPSBzaXplO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBwcml2YXRlIHNldENoaWxkcmVuUGFyZW50KFxuICAgICAgICBpdGVtOiBQZXBNZW51SXRlbSxcbiAgICAgICAgcGFyZW50OiBQZXBNZW51SXRlbVBhcmVudFxuICAgICk6IHZvaWQge1xuICAgICAgICBpdGVtLnBhcmVudCA9IHBhcmVudDtcblxuICAgICAgICBpZiAoaXRlbS5jaGlsZHJlbiAmJiBpdGVtLmNoaWxkcmVuLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIGl0ZW0uY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnNldENoaWxkcmVuUGFyZW50KGNoaWxkLCBuZXcgUGVwTWVudUl0ZW1QYXJlbnQoaXRlbSkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIHNldEl0ZW1zUGFyZW50KGl0ZW1zOiBBcnJheTxQZXBNZW51SXRlbT4pOiB2b2lkIHtcbiAgICAgICAgaWYgKGl0ZW1zKSB7XG4gICAgICAgICAgICBpdGVtcy5mb3JFYWNoKChpdGVtKSA9PiB7XG4gICAgICAgICAgICAgICAgaXRlbS5wYXJlbnQgPSBudWxsO1xuXG4gICAgICAgICAgICAgICAgaWYgKGl0ZW0uY2hpbGRyZW4gJiYgaXRlbS5jaGlsZHJlbi5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIGl0ZW0uY2hpbGRyZW4uZm9yRWFjaCgoY2hpbGQpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2V0Q2hpbGRyZW5QYXJlbnQoXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGQsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbmV3IFBlcE1lbnVJdGVtUGFyZW50KGl0ZW0pXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlVGV4dCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMudHlwZSA9PT0gJ3NlbGVjdCcgfHwgdGhpcy50eXBlID09PSAnYWN0aW9uLXNlbGVjdCcpIHtcbiAgICAgICAgICAgIHRoaXMuZGlzcGxheVRleHQgPSB0aGlzLnNlbGVjdGVkSXRlbVxuICAgICAgICAgICAgICAgID8gdGhpcy5zZWxlY3RlZEl0ZW0udGV4dFxuICAgICAgICAgICAgICAgIDogdGhpcy50ZXh0O1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kaXNwbGF5VGV4dCA9IHRoaXMudGV4dDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25DaGFuZ2VzKGNoYW5nZXMpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuaGlkZU9uRW1wdHlJdGVtcykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZSA9XG4gICAgICAgICAgICAgICAgIXRoaXMuZGlzYWJsZWQgJiZcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtcyAmJlxuICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1zLmZpbHRlcigoaXRlbSkgPT4gIWl0ZW0uZGlzYWJsZWQpLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgICAgICAgPyAndmlzaWJsZSdcbiAgICAgICAgICAgICAgICAgICAgOiAnaGlkZGVuJztcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSAndmlzaWJsZSc7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy50eXBlID09PSAnc2VsZWN0Jykge1xuICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0ZWRJdGVtID09PSBudWxsICYmXG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtcyAmJlxuICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMubGVuZ3RoID4gMFxuICAgICAgICAgICAgKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zZWxlY3RlZEl0ZW0gPSB0aGlzLml0ZW1zWzBdO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy51cGRhdGVUZXh0KCk7XG4gICAgfVxuXG4gICAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgICAgIC8vIGlmICh0aGlzLm1lbnVJdGVtQ2xpY2spIHtcbiAgICAgICAgLy8gICAgIHRoaXMubWVudUl0ZW1DbGljay51bnN1YnNjcmliZSgpO1xuICAgICAgICAvLyB9XG4gICAgfVxuXG4gICAgb25NZW51Q2xpY2tlZChldmVudCk6IHZvaWQge1xuICAgICAgICB0aGlzLm1lbnVDbGljay5lbWl0KCk7XG4gICAgfVxuXG4gICAgLy8gcHJpdmF0ZSBtYW5pcHVsYXRlRGF0YShtZW51SXRlbTogUGVwTWVudUl0ZW0pIHtcbiAgICAvLyAgICAgbWVudUl0ZW0uY2hpbGRyZW4gPSBudWxsO1xuXG4gICAgLy8gICAgIGlmIChtZW51SXRlbS5wYXJlbnQpIHtcbiAgICAvLyAgICAgICAgIG1lbnVJdGVtLnBhcmVudCA9IG5ldyBQZXBNZW51SXRlbShtZW51SXRlbS5wYXJlbnQpO1xuICAgIC8vICAgICAgICAgdGhpcy5tYW5pcHVsYXRlRGF0YShtZW51SXRlbS5wYXJlbnQpO1xuICAgIC8vICAgICB9XG4gICAgLy8gfVxuXG4gICAgb25NZW51SXRlbUNsaWNrZWQoY2xpY2s6IElQZXBNZW51SXRlbUNsaWNrRXZlbnQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZEl0ZW0gPSBjbGljay5zb3VyY2U7XG4gICAgICAgIHRoaXMudXBkYXRlVGV4dCgpO1xuXG4gICAgICAgIC8vIE1hbmlwdWxhdGUgY2xpY2sgZGF0YSBiZWNhdXNlIHRoZSBkYXRhIGlzIGR1cHBsaWNhdGUgaW4gcGFyZW50LmNoaWxkcmVuXG4gICAgICAgIC8vIGNvbnN0IHRtcCA9IG5ldyBQZXBNZW51SXRlbShjbGljay5zb3VyY2UpO1xuICAgICAgICAvLyB0aGlzLm1hbmlwdWxhdGVEYXRhKHRtcCk7XG4gICAgICAgIC8vIGNsaWNrLnNvdXJjZSA9IHRtcDtcblxuICAgICAgICB0aGlzLm1lbnVJdGVtQ2xpY2suZW1pdChjbGljayk7XG4gICAgfVxuXG4gICAgYW5pbWF0aW9uRG9uZSgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICdoaWRkZW4nKSB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLnN0YXRlQ2hhbmdlLmVtaXQoeyBzdGF0ZTogdGhpcy5zdGF0ZSB9KTtcbiAgICAgICAgICAgIH0sIDUwMCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhbmltYXRpb25TdGFydCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuc3RhdGUgPT09ICd2aXNpYmxlJykge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZUNoYW5nZS5lbWl0KHsgc3RhdGU6IHRoaXMuc3RhdGUgfSk7XG4gICAgICAgIH1cbiAgICB9XG59XG4iXX0=