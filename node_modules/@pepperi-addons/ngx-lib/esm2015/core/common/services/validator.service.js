import { coerceNumberProperty } from '@angular/cdk/coercion';
import { Injectable, Optional } from '@angular/core';
import { TranslateService } from '@ngx-translate/core';
import { FormControl, Validators, } from '@angular/forms';
import * as i0 from "@angular/core";
import * as i1 from "@ngx-translate/core";
export class PepValidatorService {
    constructor(translate = null) {
        var _a;
        this.translate = translate;
        //  Regular expressions
        this.integerUnsigned = '^[0-9]*$';
        this.integerSigned = '^-?[0-9]+$';
        this.decimalUnsigned = '^[0-9]+(.[0-9]+)?$';
        this.decimalSigned = '^-?[0-9]+(.[0-9]+)?$';
        this.phone = '^[+]*[(]{0,1}[0-9]{1,4}[)]{0,1}[-s./0-9]*$';
        this.decimalSeparator = '.';
        const currentLang = ((_a = this.translate) === null || _a === void 0 ? void 0 : _a.currentLang) || navigator.language;
        // Check for number with thousands seperator and if === ',' then the decimal seperator is '.' else ','
        const tmp = new Intl.NumberFormat(currentLang, {
            maximumSignificantDigits: 2,
        }).format(1000);
        this.decimalSeparator = tmp.indexOf(',') === 1 ? '.' : ',';
        this.decimalUnsigned = `^[0-9]+(${this.decimalSeparator}[0-9]+)?$`;
        this.decimalSigned = `^-?[0-9]+(${this.decimalSeparator}[0-9]+)?$`;
    }
    /*
        ValidatorFn functions
    */
    isEqual(target) {
        return (control) => {
            if (control.value) {
                return target.value !== control.value
                    ? { equal: { value: true } }
                    : null;
            }
            else {
                return null;
            }
        };
    }
    isGreaterThan(target) {
        return (control) => {
            if (control.value && typeof target.value === 'number') {
                return target.value > control.value
                    ? { greater: { value: true } }
                    : null;
            }
            else if (control.value && typeof target.value === 'string') {
                const controlValueNumer = coerceNumberProperty(control.value);
                const targetValueNumer = coerceNumberProperty(target.value);
                return targetValueNumer > controlValueNumer
                    ? { greater: { value: true } }
                    : null;
            }
            else {
                return null;
            }
        };
    }
    isLessThan(target) {
        return (control) => {
            if (control.value && typeof target.value === 'number') {
                return target.value < control.value
                    ? { less: { value: true } }
                    : null;
            }
            else if (control.value && typeof target.value === 'string') {
                const controlValueNumer = coerceNumberProperty(control.value);
                const targetValueNumer = coerceNumberProperty(target.value);
                return targetValueNumer < controlValueNumer
                    ? { less: { value: true } }
                    : null;
            }
            else {
                return null;
            }
        };
    }
    checkEmails(separator) {
        return (control) => {
            if (control.value) {
                const emails = control.value.split(separator ? separator : ',');
                const ctrl = new FormControl('', [
                    Validators.required,
                    Validators.email,
                ]);
                const result = emails.every((val) => {
                    ctrl.setValue(val);
                    return ctrl.valid;
                });
                return !result ? { emails: { value: true } } : null;
            }
            else {
                return null;
            }
        };
    }
    zipCodeValidator() {
        return Validators.pattern(/^(\d{5}(-\d{4})?|[A-Z]\d[A-Z] *\d[A-Z]\d)$/);
    }
    allowableCharactersValidator() {
        return Validators.pattern(/^[a-zA-Z0-9`~!@#$%^&*()_+}{|":?><,./;'\\\]\[=\- ]+$/);
    }
    allowableCharactersWithoutNumberValidator() {
        return Validators.pattern(/^[a-zA-Z`~!@#$%^&*()_+}{|":?><,./;'\\\]\[=\- ]+$/);
    }
    allowableCharactersWithoutSpecialValidator() {
        return Validators.pattern(/^[a-zA-Z0-9 ]+$/);
    }
    dateValidator() {
        return Validators.pattern(/^(?:(0[1-9]|1[012])[\/.](0[1-9]|[12][0-9]|3[01])[\/.](19|20)[0-9]{2})$/);
    }
    numberValidator() {
        return Validators.pattern(/^[0-9]*$/);
    }
    /*
        RegExp functions
    */
    validateNumber(value, allowDecimal) {
        // choose the appropiate regular expression
        let regex;
        if (allowDecimal) {
            regex = this.decimalSigned;
        }
        else {
            regex = this.integerSigned;
        }
        // when a numbers begins with a decimal separator,
        // fix it adding a zero in the beginning
        const firstCharacter = value.charAt(0);
        if (firstCharacter == this.decimalSeparator)
            value = 0 + value;
        // when a numbers ends with a decimal separator,
        // fix it adding a zero in the end
        const lastCharacter = value.charAt(value.length - 1);
        if (lastCharacter == this.decimalSeparator)
            value = value + 0;
        // test number with regular expression, when
        // number is invalid, replace it with a zero
        const valid = new RegExp(regex).test(value);
        return valid ? value : null;
    }
    validatePhone(value) {
        // test phone with regular expression, when
        // phone is invalid, replace it with the previousValue
        const valid = new RegExp(this.phone).test(value);
        return valid;
    }
    getName(e) {
        if (e.key) {
            return e.key;
        }
        else {
            // for old browsers
            if (e.keyCode && String.fromCharCode) {
                switch (e.keyCode) {
                    case 8:
                        return 'Backspace';
                    case 9:
                        return 'Tab';
                    case 27:
                        return 'Escape';
                    case 37:
                        return 'ArrowLeft';
                    case 39:
                        return 'ArrowRight';
                    case 188:
                        return ',';
                    case 190:
                        return '.';
                    case 109:
                        return '-'; // minus in numbpad
                    case 173:
                        return '-'; // minus in alphabet keyboard in firefox
                    case 189:
                        return '-'; // minus in alphabet keyboard in chrome
                    default:
                        return String.fromCharCode(e.keyCode);
                }
            }
        }
    }
    allowKeyboardNonNumericCharacters(allowedKeys, key, controlOrCommand) {
        const defaultAllowedKeys = [
            'Backspace',
            'ArrowLeft',
            'ArrowRight',
            'Escape',
            'Tab',
            'Home',
            'End',
            'Delete',
        ];
        // allow some non-numeric characters
        if (defaultAllowedKeys.indexOf(key) != -1 ||
            allowedKeys.indexOf(key) != -1 ||
            // Allow: Ctrl+A and Command+A
            (key == 'a' && controlOrCommand) ||
            // Allow: Ctrl+C and Command+C
            (key == 'c' && controlOrCommand) ||
            // Allow: Ctrl+V and Command+V
            (key == 'v' && controlOrCommand) ||
            // Allow: Ctrl+X and Command+X
            (key == 'x' && controlOrCommand) ||
            key.startsWith('F')) {
            // let it happen, don't do anything
            return true;
        }
        else {
            return false;
        }
    }
    isPhone(e) {
        const key = this.getName(e);
        const controlOrCommand = e.ctrlKey === true || e.metaKey === true;
        // allowed keys apart from numeric characters
        const allowedKeys = ['.', '-', '+', '(', ')', '*', '#'];
        // allow some non-numeric characters
        if (this.allowKeyboardNonNumericCharacters(allowedKeys, key, controlOrCommand)) {
            return true;
        }
        // allow phone characters only
        const isPhone = new RegExp(this.phone).test(key);
        return isPhone;
    }
    isNumber(e, allowDecimal) {
        const cursorPosition = e.target['selectionStart'];
        const originalValue = e.target['value'];
        const key = this.getName(e);
        const controlOrCommand = e.ctrlKey === true || e.metaKey === true;
        const signExists = originalValue.includes('-');
        const separatorExists = originalValue.includes(this.decimalSeparator);
        // allowed keys apart from numeric characters
        const allowedKeys = [];
        // when decimals are allowed, add
        // decimal separator to allowed codes when
        // its position is not close to the the sign (-. and .-)
        const separatorIsCloseToSign = signExists && cursorPosition <= 1;
        if (allowDecimal && !separatorIsCloseToSign && !separatorExists) {
            if (this.decimalSeparator == '.')
                allowedKeys.push('.');
            else
                allowedKeys.push(',');
        }
        // when minus sign is allowed, add its
        // key to allowed key only when the
        // cursor is in the first position, and
        // first character is different from
        // decimal separator
        const firstCharacterIsSeparator = originalValue.charAt(0) != this.decimalSeparator;
        if (!signExists && firstCharacterIsSeparator && cursorPosition == 0) {
            allowedKeys.push('-');
        }
        // allow some non-numeric characters
        if (this.allowKeyboardNonNumericCharacters(allowedKeys, key, controlOrCommand)) {
            return true;
        }
        // allow number characters only
        const isNumber = new RegExp(this.integerUnsigned).test(key);
        return isNumber;
    }
}
PepValidatorService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PepValidatorService_Factory() { return new PepValidatorService(i0.ɵɵinject(i1.TranslateService, 8)); }, token: PepValidatorService, providedIn: "root" });
PepValidatorService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
PepValidatorService.ctorParameters = () => [
    { type: TranslateService, decorators: [{ type: Optional }] }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFsaWRhdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtbGliL3NyYy9jb3JlL2NvbW1vbi9zZXJ2aWNlcy92YWxpZGF0b3Iuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUM3RCxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUN2RCxPQUFPLEVBR0gsV0FBVyxFQUNYLFVBQVUsR0FDYixNQUFNLGdCQUFnQixDQUFDOzs7QUFLeEIsTUFBTSxPQUFPLG1CQUFtQjtJQVU1QixZQUFnQyxZQUE4QixJQUFJOztRQUFsQyxjQUFTLEdBQVQsU0FBUyxDQUF5QjtRQVRsRSx1QkFBdUI7UUFDZCxvQkFBZSxHQUFHLFVBQVUsQ0FBQztRQUM3QixrQkFBYSxHQUFHLFlBQVksQ0FBQztRQUN0QyxvQkFBZSxHQUFHLG9CQUFvQixDQUFDO1FBQ3ZDLGtCQUFhLEdBQUcsc0JBQXNCLENBQUM7UUFDOUIsVUFBSyxHQUFHLDRDQUE0QyxDQUFDO1FBRTlELHFCQUFnQixHQUFHLEdBQUcsQ0FBQztRQUduQixNQUFNLFdBQVcsR0FBRyxDQUFBLE1BQUEsSUFBSSxDQUFDLFNBQVMsMENBQUUsV0FBVyxLQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUM7UUFFdEUsc0dBQXNHO1FBQ3RHLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUU7WUFDM0Msd0JBQXdCLEVBQUUsQ0FBQztTQUM5QixDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2hCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxL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LENBQUMsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLENBQUM7UUFDckQsSUFBSSxDQUFDLFVBQVUsSUFBSSx5QkFBeUIsSUFBSSxjQUFjLElBQUksQ0FBQyxFQUFFO1lBQ2pFLFdBQVcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7U0FDekI7UUFFRCxvQ0FBb0M7UUFDcEMsSUFDSSxJQUFJLENBQUMsaUNBQWlDLENBQ2xDLFdBQVcsRUFDWCxHQUFHLEVBQ0gsZ0JBQWdCLENBQ25CLEVBQ0g7WUFDRSxPQUFPLElBQUksQ0FBQztTQUNmO1FBRUQsK0JBQStCO1FBQy9CLE1BQU0sUUFBUSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDNUQsT0FBTyxRQUFRLENBQUM7SUFDcEIsQ0FBQzs7OztZQWpUSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7OztZQVZRLGdCQUFnQix1QkFxQlIsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGNvZXJjZU51bWJlclByb3BlcnR5IH0gZnJvbSAnQGFuZ3VsYXIvY2RrL2NvZXJjaW9uJztcbmltcG9ydCB7IEluamVjdGFibGUsIE9wdGlvbmFsIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBUcmFuc2xhdGVTZXJ2aWNlIH0gZnJvbSAnQG5neC10cmFuc2xhdGUvY29yZSc7XG5pbXBvcnQge1xuICAgIEFic3RyYWN0Q29udHJvbCxcbiAgICBWYWxpZGF0b3JGbixcbiAgICBGb3JtQ29udHJvbCxcbiAgICBWYWxpZGF0b3JzLFxufSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFBlcFZhbGlkYXRvclNlcnZpY2Uge1xuICAgIC8vICBSZWd1bGFyIGV4cHJlc3Npb25zXG4gICAgcmVhZG9ubHkgaW50ZWdlclVuc2lnbmVkID0gJ15bMC05XSokJztcbiAgICByZWFkb25seSBpbnRlZ2VyU2lnbmVkID0gJ14tP1swLTldKyQnO1xuICAgIGRlY2ltYWxVbnNpZ25lZCA9ICdeWzAtOV0rKC5bMC05XSspPyQnO1xuICAgIGRlY2ltYWxTaWduZWQgPSAnXi0/WzAtOV0rKC5bMC05XSspPyQnO1xuICAgIHJlYWRvbmx5IHBob25lID0gJ15bK10qWyhdezAsMX1bMC05XXsxLDR9WyldezAsMX1bLXMuLzAtOV0qJCc7XG5cbiAgICBkZWNpbWFsU2VwYXJhdG9yID0gJy4nO1xuXG4gICAgY29uc3RydWN0b3IoQE9wdGlvbmFsKCkgcHJpdmF0ZSB0cmFuc2xhdGU6IFRyYW5zbGF0ZVNlcnZpY2UgPSBudWxsKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRMYW5nID0gdGhpcy50cmFuc2xhdGU/LmN1cnJlbnRMYW5nIHx8IG5hdmlnYXRvci5sYW5ndWFnZTtcblxuICAgICAgICAvLyBDaGVjayBmb3IgbnVtYmVyIHdpdGggdGhvdXNhbmRzIHNlcGVyYXRvciBhbmQgaWYgPT09ICcsJyB0aGVuIHRoZSBkZWNpbWFsIHNlcGVyYXRvciBpcyAnLicgZWxzZSAnLCdcbiAgICAgICAgY29uc3QgdG1wID0gbmV3IEludGwuTnVtYmVyRm9ybWF0KGN1cnJlbnRMYW5nLCB7XG4gICAgICAgICAgICBtYXhpbXVtU2lnbmlmaWNhbnREaWdpdHM6IDIsXG4gICAgICAgIH0pLmZvcm1hdCgxMDAwKTtcbiAgICAgICAgdGhpcy5kZWNpbWFsU2VwYXJhdG9yID0gdG1wLmluZGV4T2YoJywnKSA9PT0gMSA/ICcuJyA6ICcsJztcblxuICAgICAgICB0aGlzLmRlY2ltYWxVbnNpZ25lZCA9IGBeWzAtOV0rKCR7dGhpcy5kZWNpbWFsU2VwYXJhdG9yfVswLTldKyk/JGA7XG4gICAgICAgIHRoaXMuZGVjaW1hbFNpZ25lZCA9IGBeLT9bMC05XSsoJHt0aGlzLmRlY2ltYWxTZXBhcmF0b3J9WzAtOV0rKT8kYDtcbiAgICB9XG5cbiAgICAvKlxuICAgICAgICBWYWxpZGF0b3JGbiBmdW5jdGlvbnNcbiAgICAqL1xuICAgIGlzRXF1YWwodGFyZ2V0OiBGb3JtQ29udHJvbCB8IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRvckZuIHtcbiAgICAgICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoY29udHJvbC52YWx1ZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXQudmFsdWUgIT09IGNvbnRyb2wudmFsdWVcbiAgICAgICAgICAgICAgICAgICAgPyB7IGVxdWFsOiB7IHZhbHVlOiB0cnVlIH0gfVxuICAgICAgICAgICAgICAgICAgICA6IG51bGw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIGlzR3JlYXRlclRoYW4odGFyZ2V0OiBGb3JtQ29udHJvbCB8IEFic3RyYWN0Q29udHJvbCk6IFZhbGlkYXRvckZuIHtcbiAgICAgICAgcmV0dXJuIChjb250cm9sOiBBYnN0cmFjdENvbnRyb2wpOiB7IFtrZXk6IHN0cmluZ106IGFueSB9IHwgbnVsbCA9PiB7XG4gICAgICAgICAgICBpZiAoY29udHJvbC52YWx1ZSAmJiB0eXBlb2YgdGFyZ2V0LnZhbHVlID09PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXQudmFsdWUgPiBjb250cm9sLnZhbHVlXG4gICAgICAgICAgICAgICAgICAgID8geyBncmVhdGVyOiB7IHZhbHVlOiB0cnVlIH0gfVxuICAgICAgICAgICAgICAgICAgICA6IG51bGw7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGNvbnRyb2wudmFsdWUgJiYgdHlwZW9mIHRhcmdldC52YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBjb250cm9sVmFsdWVOdW1lciA9IGNvZXJjZU51bWJlclByb3BlcnR5KGNvbnRyb2wudmFsdWUpO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRhcmdldFZhbHVlTnVtZXIgPSBjb2VyY2VOdW1iZXJQcm9wZXJ0eSh0YXJnZXQudmFsdWUpO1xuXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRhcmdldFZhbHVlTnVtZXIgPiBjb250cm9sVmFsdWVOdW1lclxuICAgICAgICAgICAgICAgICAgICA/IHsgZ3JlYXRlcjogeyB2YWx1ZTogdHJ1ZSB9IH1cbiAgICAgICAgICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9XG5cbiAgICBpc0xlc3NUaGFuKHRhcmdldDogRm9ybUNvbnRyb2wgfCBBYnN0cmFjdENvbnRyb2wpOiBWYWxpZGF0b3JGbiB7XG4gICAgICAgIHJldHVybiAoY29udHJvbDogQWJzdHJhY3RDb250cm9sKTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSB8IG51bGwgPT4ge1xuICAgICAgICAgICAgaWYgKGNvbnRyb2wudmFsdWUgJiYgdHlwZW9mIHRhcmdldC52YWx1ZSA9PT0gJ251bWJlcicpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdGFyZ2V0LnZhbHVlIDwgY29udHJvbC52YWx1ZVxuICAgICAgICAgICAgICAgICAgICA/IHsgbGVzczogeyB2YWx1ZTogdHJ1ZSB9IH1cbiAgICAgICAgICAgICAgICAgICAgOiBudWxsO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChjb250cm9sLnZhbHVlICYmIHR5cGVvZiB0YXJnZXQudmFsdWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY29udHJvbFZhbHVlTnVtZXIgPSBjb2VyY2VOdW1iZXJQcm9wZXJ0eShjb250cm9sLnZhbHVlKTtcbiAgICAgICAgICAgICAgICBjb25zdCB0YXJnZXRWYWx1ZU51bWVyID0gY29lcmNlTnVtYmVyUHJvcGVydHkodGFyZ2V0LnZhbHVlKTtcblxuICAgICAgICAgICAgICAgIHJldHVybiB0YXJnZXRWYWx1ZU51bWVyIDwgY29udHJvbFZhbHVlTnVtZXJcbiAgICAgICAgICAgICAgICAgICAgPyB7IGxlc3M6IHsgdmFsdWU6IHRydWUgfSB9XG4gICAgICAgICAgICAgICAgICAgIDogbnVsbDtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgY2hlY2tFbWFpbHMoc2VwYXJhdG9yPzogc3RyaW5nKTogVmFsaWRhdG9yRm4ge1xuICAgICAgICByZXR1cm4gKGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCk6IHsgW2tleTogc3RyaW5nXTogYW55IH0gfCBudWxsID0+IHtcbiAgICAgICAgICAgIGlmIChjb250cm9sLnZhbHVlKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgZW1haWxzID0gY29udHJvbC52YWx1ZS5zcGxpdChzZXBhcmF0b3IgPyBzZXBhcmF0b3IgOiAnLCcpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGN0cmwgPSBuZXcgRm9ybUNvbnRyb2woJycsIFtcbiAgICAgICAgICAgICAgICAgICAgVmFsaWRhdG9ycy5yZXF1aXJlZCxcbiAgICAgICAgICAgICAgICAgICAgVmFsaWRhdG9ycy5lbWFpbCxcbiAgICAgICAgICAgICAgICBdKTtcbiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBlbWFpbHMuZXZlcnkoKHZhbDogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGN0cmwuc2V0VmFsdWUodmFsKTtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGN0cmwudmFsaWQ7XG4gICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICByZXR1cm4gIXJlc3VsdCA/IHsgZW1haWxzOiB7IHZhbHVlOiB0cnVlIH0gfSA6IG51bGw7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgIH1cblxuICAgIHppcENvZGVWYWxpZGF0b3IoKTogVmFsaWRhdG9yRm4ge1xuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5wYXR0ZXJuKC9eKFxcZHs1fSgtXFxkezR9KT98W0EtWl1cXGRbQS1aXSAqXFxkW0EtWl1cXGQpJC8pO1xuICAgIH1cblxuICAgIGFsbG93YWJsZUNoYXJhY3RlcnNWYWxpZGF0b3IoKTogVmFsaWRhdG9yRm4ge1xuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5wYXR0ZXJuKFxuICAgICAgICAgICAgL15bYS16QS1aMC05YH4hQCMkJV4mKigpXyt9e3xcIjo/PjwsLi87J1xcXFxcXF1cXFs9XFwtIF0rJC9cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBhbGxvd2FibGVDaGFyYWN0ZXJzV2l0aG91dE51bWJlclZhbGlkYXRvcigpOiBWYWxpZGF0b3JGbiB7XG4gICAgICAgIHJldHVybiBWYWxpZGF0b3JzLnBhdHRlcm4oXG4gICAgICAgICAgICAvXlthLXpBLVpgfiFAIyQlXiYqKClfK317fFwiOj8+PCwuLzsnXFxcXFxcXVxcWz1cXC0gXSskL1xuICAgICAgICApO1xuICAgIH1cblxuICAgIGFsbG93YWJsZUNoYXJhY3RlcnNXaXRob3V0U3BlY2lhbFZhbGlkYXRvcigpOiBWYWxpZGF0b3JGbiB7XG4gICAgICAgIHJldHVybiBWYWxpZGF0b3JzLnBhdHRlcm4oL15bYS16QS1aMC05IF0rJC8pO1xuICAgIH1cblxuICAgIGRhdGVWYWxpZGF0b3IoKTogVmFsaWRhdG9yRm4ge1xuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5wYXR0ZXJuKFxuICAgICAgICAgICAgL14oPzooMFsxLTldfDFbMDEyXSlbXFwvLl0oMFsxLTldfFsxMl1bMC05XXwzWzAxXSlbXFwvLl0oMTl8MjApWzAtOV17Mn0pJC9cbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBudW1iZXJWYWxpZGF0b3IoKTogVmFsaWRhdG9yRm4ge1xuICAgICAgICByZXR1cm4gVmFsaWRhdG9ycy5wYXR0ZXJuKC9eWzAtOV0qJC8pO1xuICAgIH1cblxuICAgIC8qXG4gICAgICAgIFJlZ0V4cCBmdW5jdGlvbnNcbiAgICAqL1xuICAgIHZhbGlkYXRlTnVtYmVyKHZhbHVlOiBzdHJpbmcsIGFsbG93RGVjaW1hbDogYm9vbGVhbik6IHN0cmluZyB7XG4gICAgICAgIC8vIGNob29zZSB0aGUgYXBwcm9waWF0ZSByZWd1bGFyIGV4cHJlc3Npb25cbiAgICAgICAgbGV0IHJlZ2V4OiBzdHJpbmc7XG5cbiAgICAgICAgaWYgKGFsbG93RGVjaW1hbCkge1xuICAgICAgICAgICAgcmVnZXggPSB0aGlzLmRlY2ltYWxTaWduZWQ7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZWdleCA9IHRoaXMuaW50ZWdlclNpZ25lZDtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIHdoZW4gYSBudW1iZXJzIGJlZ2lucyB3aXRoIGEgZGVjaW1hbCBzZXBhcmF0b3IsXG4gICAgICAgIC8vIGZpeCBpdCBhZGRpbmcgYSB6ZXJvIGluIHRoZSBiZWdpbm5pbmdcbiAgICAgICAgY29uc3QgZmlyc3RDaGFyYWN0ZXIgPSB2YWx1ZS5jaGFyQXQoMCk7XG4gICAgICAgIGlmIChmaXJzdENoYXJhY3RlciA9PSB0aGlzLmRlY2ltYWxTZXBhcmF0b3IpIHZhbHVlID0gMCArIHZhbHVlO1xuXG4gICAgICAgIC8vIHdoZW4gYSBudW1iZXJzIGVuZHMgd2l0aCBhIGRlY2ltYWwgc2VwYXJhdG9yLFxuICAgICAgICAvLyBmaXggaXQgYWRkaW5nIGEgemVybyBpbiB0aGUgZW5kXG4gICAgICAgIGNvbnN0IGxhc3RDaGFyYWN0ZXIgPSB2YWx1ZS5jaGFyQXQodmFsdWUubGVuZ3RoIC0gMSk7XG4gICAgICAgIGlmIChsYXN0Q2hhcmFjdGVyID09IHRoaXMuZGVjaW1hbFNlcGFyYXRvcikgdmFsdWUgPSB2YWx1ZSArIDA7XG5cbiAgICAgICAgLy8gdGVzdCBudW1iZXIgd2l0aCByZWd1bGFyIGV4cHJlc3Npb24sIHdoZW5cbiAgICAgICAgLy8gbnVtYmVyIGlzIGludmFsaWQsIHJlcGxhY2UgaXQgd2l0aCBhIHplcm9cbiAgICAgICAgY29uc3QgdmFsaWQ6IGJvb2xlYW4gPSBuZXcgUmVnRXhwKHJlZ2V4KS50ZXN0KHZhbHVlKTtcblxuICAgICAgICByZXR1cm4gdmFsaWQgPyB2YWx1ZSA6IG51bGw7XG4gICAgfVxuXG4gICAgdmFsaWRhdGVQaG9uZSh2YWx1ZTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgICAgIC8vIHRlc3QgcGhvbmUgd2l0aCByZWd1bGFyIGV4cHJlc3Npb24sIHdoZW5cbiAgICAgICAgLy8gcGhvbmUgaXMgaW52YWxpZCwgcmVwbGFjZSBpdCB3aXRoIHRoZSBwcmV2aW91c1ZhbHVlXG4gICAgICAgIGNvbnN0IHZhbGlkOiBib29sZWFuID0gbmV3IFJlZ0V4cCh0aGlzLnBob25lKS50ZXN0KHZhbHVlKTtcbiAgICAgICAgcmV0dXJuIHZhbGlkO1xuICAgIH1cblxuICAgIHByaXZhdGUgZ2V0TmFtZShlKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKGUua2V5KSB7XG4gICAgICAgICAgICByZXR1cm4gZS5rZXk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAvLyBmb3Igb2xkIGJyb3dzZXJzXG4gICAgICAgICAgICBpZiAoZS5rZXlDb2RlICYmIFN0cmluZy5mcm9tQ2hhckNvZGUpIHtcbiAgICAgICAgICAgICAgICBzd2l0Y2ggKGUua2V5Q29kZSkge1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDg6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ0JhY2tzcGFjZSc7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgOTpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnVGFiJztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAyNzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnRXNjYXBlJztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAzNzpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnQXJyb3dMZWZ0JztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAzOTpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnQXJyb3dSaWdodCc7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTg4OlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICcsJztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxOTA6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJy4nO1xuICAgICAgICAgICAgICAgICAgICBjYXNlIDEwOTpcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnLSc7IC8vIG1pbnVzIGluIG51bWJwYWRcbiAgICAgICAgICAgICAgICAgICAgY2FzZSAxNzM6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJy0nOyAvLyBtaW51cyBpbiBhbHBoYWJldCBrZXlib2FyZCBpbiBmaXJlZm94XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgMTg5OlxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICctJzsgLy8gbWludXMgaW4gYWxwaGFiZXQga2V5Ym9hcmQgaW4gY2hyb21lXG4gICAgICAgICAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShlLmtleUNvZGUpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgYWxsb3dLZXlib2FyZE5vbk51bWVyaWNDaGFyYWN0ZXJzKFxuICAgICAgICBhbGxvd2VkS2V5czogQXJyYXk8c3RyaW5nPixcbiAgICAgICAga2V5OiBzdHJpbmcsXG4gICAgICAgIGNvbnRyb2xPckNvbW1hbmQ6IGJvb2xlYW5cbiAgICApOiBib29sZWFuIHtcbiAgICAgICAgY29uc3QgZGVmYXVsdEFsbG93ZWRLZXlzID0gW1xuICAgICAgICAgICAgJ0JhY2tzcGFjZScsXG4gICAgICAgICAgICAnQXJyb3dMZWZ0JyxcbiAgICAgICAgICAgICdBcnJvd1JpZ2h0JyxcbiAgICAgICAgICAgICdFc2NhcGUnLFxuICAgICAgICAgICAgJ1RhYicsXG4gICAgICAgICAgICAnSG9tZScsXG4gICAgICAgICAgICAnRW5kJyxcbiAgICAgICAgICAgICdEZWxldGUnLFxuICAgICAgICBdO1xuXG4gICAgICAgIC8vIGFsbG93IHNvbWUgbm9uLW51bWVyaWMgY2hhcmFjdGVyc1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICBkZWZhdWx0QWxsb3dlZEtleXMuaW5kZXhPZihrZXkpICE9IC0xIHx8XG4gICAgICAgICAgICBhbGxvd2VkS2V5cy5pbmRleE9mKGtleSkgIT0gLTEgfHxcbiAgICAgICAgICAgIC8vIEFsbG93OiBDdHJsK0EgYW5kIENvbW1hbmQrQVxuICAgICAgICAgICAgKGtleSA9PSAnYScgJiYgY29udHJvbE9yQ29tbWFuZCkgfHxcbiAgICAgICAgICAgIC8vIEFsbG93OiBDdHJsK0MgYW5kIENvbW1hbmQrQ1xuICAgICAgICAgICAgKGtleSA9PSAnYycgJiYgY29udHJvbE9yQ29tbWFuZCkgfHxcbiAgICAgICAgICAgIC8vIEFsbG93OiBDdHJsK1YgYW5kIENvbW1hbmQrVlxuICAgICAgICAgICAgKGtleSA9PSAndicgJiYgY29udHJvbE9yQ29tbWFuZCkgfHxcbiAgICAgICAgICAgIC8vIEFsbG93OiBDdHJsK1ggYW5kIENvbW1hbmQrWFxuICAgICAgICAgICAgKGtleSA9PSAneCcgJiYgY29udHJvbE9yQ29tbWFuZCkgfHxcbiAgICAgICAgICAgIGtleS5zdGFydHNXaXRoKCdGJylcbiAgICAgICAgKSB7XG4gICAgICAgICAgICAvLyBsZXQgaXQgaGFwcGVuLCBkb24ndCBkbyBhbnl0aGluZ1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpc1Bob25lKGU6IEtleWJvYXJkRXZlbnQpOiBib29sZWFuIHtcbiAgICAgICAgY29uc3Qga2V5OiBzdHJpbmcgPSB0aGlzLmdldE5hbWUoZSk7XG4gICAgICAgIGNvbnN0IGNvbnRyb2xPckNvbW1hbmQgPSBlLmN0cmxLZXkgPT09IHRydWUgfHwgZS5tZXRhS2V5ID09PSB0cnVlO1xuXG4gICAgICAgIC8vIGFsbG93ZWQga2V5cyBhcGFydCBmcm9tIG51bWVyaWMgY2hhcmFjdGVyc1xuICAgICAgICBjb25zdCBhbGxvd2VkS2V5cyA9IFsnLicsICctJywgJysnLCAnKCcsICcpJywgJyonLCAnIyddO1xuXG4gICAgICAgIC8vIGFsbG93IHNvbWUgbm9uLW51bWVyaWMgY2hhcmFjdGVyc1xuICAgICAgICBpZiAoXG4gICAgICAgICAgICB0aGlzLmFsbG93S2V5Ym9hcmROb25OdW1lcmljQ2hhcmFjdGVycyhcbiAgICAgICAgICAgICAgICBhbGxvd2VkS2V5cyxcbiAgICAgICAgICAgICAgICBrZXksXG4gICAgICAgICAgICAgICAgY29udHJvbE9yQ29tbWFuZFxuICAgICAgICAgICAgKVxuICAgICAgICApIHtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWxsb3cgcGhvbmUgY2hhcmFjdGVycyBvbmx5XG4gICAgICAgIGNvbnN0IGlzUGhvbmUgPSBuZXcgUmVnRXhwKHRoaXMucGhvbmUpLnRlc3Qoa2V5KTtcbiAgICAgICAgcmV0dXJuIGlzUGhvbmU7XG4gICAgfVxuXG4gICAgaXNOdW1iZXIoZTogS2V5Ym9hcmRFdmVudCwgYWxsb3dEZWNpbWFsOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgICAgIGNvbnN0IGN1cnNvclBvc2l0aW9uOiBudW1iZXIgPSBlLnRhcmdldFsnc2VsZWN0aW9uU3RhcnQnXTtcbiAgICAgICAgY29uc3Qgb3JpZ2luYWxWYWx1ZTogc3RyaW5nID0gZS50YXJnZXRbJ3ZhbHVlJ107XG4gICAgICAgIGNvbnN0IGtleTogc3RyaW5nID0gdGhpcy5nZXROYW1lKGUpO1xuICAgICAgICBjb25zdCBjb250cm9sT3JDb21tYW5kID0gZS5jdHJsS2V5ID09PSB0cnVlIHx8IGUubWV0YUtleSA9PT0gdHJ1ZTtcbiAgICAgICAgY29uc3Qgc2lnbkV4aXN0cyA9IG9yaWdpbmFsVmFsdWUuaW5jbHVkZXMoJy0nKTtcbiAgICAgICAgY29uc3Qgc2VwYXJhdG9yRXhpc3RzID0gb3JpZ2luYWxWYWx1ZS5pbmNsdWRlcyh0aGlzLmRlY2ltYWxTZXBhcmF0b3IpO1xuXG4gICAgICAgIC8vIGFsbG93ZWQga2V5cyBhcGFydCBmcm9tIG51bWVyaWMgY2hhcmFjdGVyc1xuICAgICAgICBjb25zdCBhbGxvd2VkS2V5cyA9IFtdO1xuXG4gICAgICAgIC8vIHdoZW4gZGVjaW1hbHMgYXJlIGFsbG93ZWQsIGFkZFxuICAgICAgICAvLyBkZWNpbWFsIHNlcGFyYXRvciB0byBhbGxvd2VkIGNvZGVzIHdoZW5cbiAgICAgICAgLy8gaXRzIHBvc2l0aW9uIGlzIG5vdCBjbG9zZSB0byB0aGUgdGhlIHNpZ24gKC0uIGFuZCAuLSlcbiAgICAgICAgY29uc3Qgc2VwYXJhdG9ySXNDbG9zZVRvU2lnbiA9IHNpZ25FeGlzdHMgJiYgY3Vyc29yUG9zaXRpb24gPD0gMTtcbiAgICAgICAgaWYgKGFsbG93RGVjaW1hbCAmJiAhc2VwYXJhdG9ySXNDbG9zZVRvU2lnbiAmJiAhc2VwYXJhdG9yRXhpc3RzKSB7XG4gICAgICAgICAgICBpZiAodGhpcy5kZWNpbWFsU2VwYXJhdG9yID09ICcuJykgYWxsb3dlZEtleXMucHVzaCgnLicpO1xuICAgICAgICAgICAgZWxzZSBhbGxvd2VkS2V5cy5wdXNoKCcsJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyB3aGVuIG1pbnVzIHNpZ24gaXMgYWxsb3dlZCwgYWRkIGl0c1xuICAgICAgICAvLyBrZXkgdG8gYWxsb3dlZCBrZXkgb25seSB3aGVuIHRoZVxuICAgICAgICAvLyBjdXJzb3IgaXMgaW4gdGhlIGZpcnN0IHBvc2l0aW9uLCBhbmRcbiAgICAgICAgLy8gZmlyc3QgY2hhcmFjdGVyIGlzIGRpZmZlcmVudCBmcm9tXG4gICAgICAgIC8vIGRlY2ltYWwgc2VwYXJhdG9yXG4gICAgICAgIGNvbnN0IGZpcnN0Q2hhcmFjdGVySXNTZXBhcmF0b3IgPVxuICAgICAgICAgICAgb3JpZ2luYWxWYWx1ZS5jaGFyQXQoMCkgIT0gdGhpcy5kZWNpbWFsU2VwYXJhdG9yO1xuICAgICAgICBpZiAoIXNpZ25FeGlzdHMgJiYgZmlyc3RDaGFyYWN0ZXJJc1NlcGFyYXRvciAmJiBjdXJzb3JQb3NpdGlvbiA9PSAwKSB7XG4gICAgICAgICAgICBhbGxvd2VkS2V5cy5wdXNoKCctJyk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBhbGxvdyBzb21lIG5vbi1udW1lcmljIGNoYXJhY3RlcnNcbiAgICAgICAgaWYgKFxuICAgICAgICAgICAgdGhpcy5hbGxvd0tleWJvYXJkTm9uTnVtZXJpY0NoYXJhY3RlcnMoXG4gICAgICAgICAgICAgICAgYWxsb3dlZEtleXMsXG4gICAgICAgICAgICAgICAga2V5LFxuICAgICAgICAgICAgICAgIGNvbnRyb2xPckNvbW1hbmRcbiAgICAgICAgICAgIClcbiAgICAgICAgKSB7XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIGFsbG93IG51bWJlciBjaGFyYWN0ZXJzIG9ubHlcbiAgICAgICAgY29uc3QgaXNOdW1iZXIgPSBuZXcgUmVnRXhwKHRoaXMuaW50ZWdlclVuc2lnbmVkKS50ZXN0KGtleSk7XG4gICAgICAgIHJldHVybiBpc051bWJlcjtcbiAgICB9XG59XG4iXX0=