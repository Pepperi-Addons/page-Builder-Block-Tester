import { Injectable } from '@angular/core';
import { HttpClient, HttpHeaders, } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError } from 'rxjs/operators';
import { PepSessionService } from '../../common/services/session.service';
import { PepCookieService } from '../../common/services/cookie.service';
import * as i0 from "@angular/core";
import * as i1 from "../../common/services/session.service";
import * as i2 from "../../common/services/cookie.service";
import * as i3 from "@angular/common/http";
export class PepHttpService {
    constructor(sessionService, cookieService, http) {
        this.sessionService = sessionService;
        this.cookieService = cookieService;
        this.http = http;
        this.AUTH_HEADER = 'Authorization';
        this.PEPPERI_TOKEN_HEADER = 'PepperiSessionToken';
        this.WAPI_TOKEN_KEY = 'auth_token';
        this.PEPPERI_TOKEN_COOKIE = 'PepperiUserSettings';
    }
    handleError(response) {
        let errorMessage = 'Unknown error!';
        if (response.error instanceof ErrorEvent) {
            // Client-side errors
            errorMessage = `Error: ${response.error.message}`;
        }
        else {
            // Server-side errors
            errorMessage = this.getServerErrorMessage(response);
        }
        return throwError(errorMessage);
    }
    getServerErrorMessage(response) {
        var _a, _b;
        if ((_b = (_a = response === null || response === void 0 ? void 0 : response.error) === null || _a === void 0 ? void 0 : _a.fault) === null || _b === void 0 ? void 0 : _b.faultstring) {
            return `${response.error.fault.faultstring}`;
        }
        else {
            switch (response.status) {
                case 404: {
                    return `Not Found: ${response.message}`;
                }
                case 403: {
                    return `Access Denied: ${response.message}`;
                }
                case 500: {
                    return `Internal Server Error: ${response.message}`;
                }
                default: {
                    return `Unknown Server Error\nError Code: ${response.status}\nMessage: ${response.message}`;
                }
            }
        }
    }
    // Add authorization token if the token exist.
    addAuthorizationToken(httpOptions = {}) {
        if (!httpOptions.headers.has(this.AUTH_HEADER)) {
            const idpToken = this.sessionService.getIdpToken();
            if (idpToken) {
                httpOptions.headers = httpOptions.headers.set(this.AUTH_HEADER, `Bearer ${idpToken}`);
            }
        }
        return httpOptions;
    }
    // Add web api token if calling to wapi domain.
    addWebApiToken(url, httpOptions = {}) {
        if (!httpOptions.headers.has(this.PEPPERI_TOKEN_HEADER)) {
            const wapiBaseUrl = this.sessionService.getWapiBaseUrl();
            if (wapiBaseUrl && url.match(new RegExp(wapiBaseUrl, 'g'))) {
                // TODO:
                // const webApiToken = this.sessionService.getWapiToken();
                try {
                    const userSettingCookie = this.cookieService.get(this.PEPPERI_TOKEN_COOKIE);
                    const webApiToken = JSON.parse(userSettingCookie).values
                        .items[this.WAPI_TOKEN_KEY];
                    if (webApiToken) {
                        httpOptions.headers = httpOptions.headers.set(this.PEPPERI_TOKEN_HEADER, webApiToken);
                    }
                }
                catch (_a) {
                    // Do nothing.
                }
            }
        }
        return httpOptions;
    }
    setDefaultHeaderOptions(url, httpOptions = {}) {
        if (!httpOptions.headers) {
            httpOptions.headers = new HttpHeaders();
        }
        // Add content type
        if (!httpOptions.headers.has('Content-Type')) {
            httpOptions.headers = httpOptions.headers.set('Content-Type', 'application/json');
        }
        httpOptions = this.addAuthorizationToken(httpOptions);
        httpOptions = this.addWebApiToken(url, httpOptions);
        return httpOptions;
    }
    // getTextFile(filename: string): void {
    //     // The Observable returned by get() is of type Observable<string>
    //     // because a text response was specified.
    //     // There's no need to pass a <string> type parameter to get().
    //     // return this.http.get(filename, {responseType: 'text'})
    //     //     .pipe(
    //     //         tap( // Log the result or error
    //     //         data => this.log(filename, data),
    //     //         error => this.logError(filename, error)
    //     //         )
    //     // );
    // }
    getHttpCall(url, httpOptions = {}) {
        httpOptions = this.setDefaultHeaderOptions(url, httpOptions);
        return this.http
            .get(url, httpOptions)
            .pipe(catchError(this.handleError.bind(this)));
        //     .subscribe(
        //         (res) => console.log(''),
        //         (error) => console.log(''),
        //         () => {}
        // );
    }
    postHttpCall(url, body, httpOptions = {}) {
        httpOptions = this.setDefaultHeaderOptions(url, httpOptions);
        return this.http
            .post(url, body, httpOptions)
            .pipe(catchError(this.handleError.bind(this)));
        //     .subscribe(
        //         (res) => console.log(''),
        //         (error) => console.log(''),
        //         () => {}
        // );
    }
    getWapiApiCall(url, httpOptions = {}) {
        const wapiBaseUrl = this.sessionService.getWapiBaseUrl();
        return this.getHttpCall(`${wapiBaseUrl}${url}`, httpOptions);
    }
    postWapiApiCall(url, body, httpOptions = {}) {
        const wapiBaseUrl = this.sessionService.getWapiBaseUrl();
        return this.postHttpCall(`${wapiBaseUrl}${url}`, body, httpOptions);
    }
    getPapiApiCall(url, httpOptions = {}) {
        const papiBaseUrl = this.sessionService.getPapiBaseUrl();
        return this.getHttpCall(`${papiBaseUrl}${url}`, httpOptions);
    }
    postPapiApiCall(url, body, httpOptions = {}) {
        const papiBaseUrl = this.sessionService.getPapiBaseUrl();
        return this.postHttpCall(`${papiBaseUrl}${url}`, body, httpOptions);
    }
}
PepHttpService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PepHttpService_Factory() { return new PepHttpService(i0.ɵɵinject(i1.PepSessionService), i0.ɵɵinject(i2.PepCookieService), i0.ɵɵinject(i3.HttpClient)); }, token: PepHttpService, providedIn: "root" });
PepHttpService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root',
            },] }
];
PepHttpService.ctorParameters = () => [
    { type: PepSessionService },
    { type: PepCookieService },
    { type: HttpClient }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaHR0cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWxpYi9zcmMvY29yZS9odHRwL3NlcnZpY2VzL2h0dHAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFDSCxVQUFVLEVBR1YsV0FBVyxHQUNkLE1BQU0sc0JBQXNCLENBQUM7QUFDOUIsT0FBTyxFQUFFLFVBQVUsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQVMsVUFBVSxFQUFPLE1BQU0sZ0JBQWdCLENBQUM7QUFDeEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sdUNBQXVDLENBQUM7QUFDMUUsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0NBQXNDLENBQUM7Ozs7O0FBS3hFLE1BQU0sT0FBTyxjQUFjO0lBTXZCLFlBQ1ksY0FBaUMsRUFDakMsYUFBK0IsRUFDL0IsSUFBZ0I7UUFGaEIsbUJBQWMsR0FBZCxjQUFjLENBQW1CO1FBQ2pDLGtCQUFhLEdBQWIsYUFBYSxDQUFrQjtRQUMvQixTQUFJLEdBQUosSUFBSSxDQUFZO1FBUlgsZ0JBQVcsR0FBRyxlQUFlLENBQUM7UUFDOUIseUJBQW9CLEdBQUcscUJBQXFCLENBQUM7UUFDN0MsbUJBQWMsR0FBRyxZQUFZLENBQUM7UUFDOUIseUJBQW9CLEdBQUcscUJBQXFCLENBQUM7SUFNM0QsQ0FBQztJQUVJLFdBQVcsQ0FBQyxRQUEyQjtRQUMzQyxJQUFJLFlBQVksR0FBRyxnQkFBZ0IsQ0FBQztRQUNwQyxJQUFJLFFBQVEsQ0FBQyxLQUFLLFlBQVksVUFBVSxFQUFFO1lBQ3RDLHFCQUFxQjtZQUNyQixZQUFZLEdBQUcsVUFBVSxRQUFRLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1NBQ3JEO2FBQU07WUFDSCxxQkFBcUI7WUFDckIsWUFB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QVcsR0FBRyxHQUFHLEVBQUUsRUFBRSxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDeEUsQ0FBQzs7OztZQXRMSixVQUFVLFNBQUM7Z0JBQ1IsVUFBVSxFQUFFLE1BQU07YUFDckI7OztZQUxRLGlCQUFpQjtZQUNqQixnQkFBZ0I7WUFSckIsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gICAgSHR0cENsaWVudCxcbiAgICBIdHRwRXJyb3JSZXNwb25zZSxcbiAgICBIdHRwUGFyYW1zLFxuICAgIEh0dHBIZWFkZXJzLFxufSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyB0aHJvd0Vycm9yLCBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyByZXRyeSwgY2F0Y2hFcnJvciwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgUGVwU2Vzc2lvblNlcnZpY2UgfSBmcm9tICcuLi8uLi9jb21tb24vc2VydmljZXMvc2Vzc2lvbi5zZXJ2aWNlJztcbmltcG9ydCB7IFBlcENvb2tpZVNlcnZpY2UgfSBmcm9tICcuLi8uLi9jb21tb24vc2VydmljZXMvY29va2llLnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnLFxufSlcbmV4cG9ydCBjbGFzcyBQZXBIdHRwU2VydmljZSB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBBVVRIX0hFQURFUiA9ICdBdXRob3JpemF0aW9uJztcbiAgICBwcml2YXRlIHJlYWRvbmx5IFBFUFBFUklfVE9LRU5fSEVBREVSID0gJ1BlcHBlcmlTZXNzaW9uVG9rZW4nO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgV0FQSV9UT0tFTl9LRVkgPSAnYXV0aF90b2tlbic7XG4gICAgcHJpdmF0ZSByZWFkb25seSBQRVBQRVJJX1RPS0VOX0NPT0tJRSA9ICdQZXBwZXJpVXNlclNldHRpbmdzJztcblxuICAgIGNvbnN0cnVjdG9yKFxuICAgICAgICBwcml2YXRlIHNlc3Npb25TZXJ2aWNlOiBQZXBTZXNzaW9uU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBjb29raWVTZXJ2aWNlOiBQZXBDb29raWVTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnRcbiAgICApIHt9XG5cbiAgICBwcml2YXRlIGhhbmRsZUVycm9yKHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZSk6IE9ic2VydmFibGU8bmV2ZXI+IHtcbiAgICAgICAgbGV0IGVycm9yTWVzc2FnZSA9ICdVbmtub3duIGVycm9yISc7XG4gICAgICAgIGlmIChyZXNwb25zZS5lcnJvciBpbnN0YW5jZW9mIEVycm9yRXZlbnQpIHtcbiAgICAgICAgICAgIC8vIENsaWVudC1zaWRlIGVycm9yc1xuICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gYEVycm9yOiAke3Jlc3BvbnNlLmVycm9yLm1lc3NhZ2V9YDtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIC8vIFNlcnZlci1zaWRlIGVycm9yc1xuICAgICAgICAgICAgZXJyb3JNZXNzYWdlID0gdGhpcy5nZXRTZXJ2ZXJFcnJvck1lc3NhZ2UocmVzcG9uc2UpO1xuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFNlcnZlckVycm9yTWVzc2FnZShyZXNwb25zZTogSHR0cEVycm9yUmVzcG9uc2UpOiBzdHJpbmcge1xuICAgICAgICBpZiAocmVzcG9uc2U/LmVycm9yPy5mYXVsdD8uZmF1bHRzdHJpbmcpIHtcbiAgICAgICAgICAgIHJldHVybiBgJHtyZXNwb25zZS5lcnJvci5mYXVsdC5mYXVsdHN0cmluZ31gO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgc3dpdGNoIChyZXNwb25zZS5zdGF0dXMpIHtcbiAgICAgICAgICAgICAgICBjYXNlIDQwNDoge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYE5vdCBGb3VuZDogJHtyZXNwb25zZS5tZXNzYWdlfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhc2UgNDAzOiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgQWNjZXNzIERlbmllZDogJHtyZXNwb25zZS5tZXNzYWdlfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGNhc2UgNTAwOiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBgSW50ZXJuYWwgU2VydmVyIEVycm9yOiAke3Jlc3BvbnNlLm1lc3NhZ2V9YDtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZGVmYXVsdDoge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gYFVua25vd24gU2VydmVyIEVycm9yXFxuRXJyb3IgQ29kZTogJHtyZXNwb25zZS5zdGF0dXN9XFxuTWVzc2FnZTogJHtyZXNwb25zZS5tZXNzYWdlfWA7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLy8gQWRkIGF1dGhvcml6YXRpb24gdG9rZW4gaWYgdGhlIHRva2VuIGV4aXN0LlxuICAgIHByaXZhdGUgYWRkQXV0aG9yaXphdGlvblRva2VuKGh0dHBPcHRpb25zOiBhbnkgPSB7fSk6IGFueSB7XG4gICAgICAgIGlmICghaHR0cE9wdGlvbnMuaGVhZGVycy5oYXModGhpcy5BVVRIX0hFQURFUikpIHtcbiAgICAgICAgICAgIGNvbnN0IGlkcFRva2VuID0gdGhpcy5zZXNzaW9uU2VydmljZS5nZXRJZHBUb2tlbigpO1xuXG4gICAgICAgICAgICBpZiAoaWRwVG9rZW4pIHtcbiAgICAgICAgICAgICAgICBodHRwT3B0aW9ucy5oZWFkZXJzID0gaHR0cE9wdGlvbnMuaGVhZGVycy5zZXQoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuQVVUSF9IRUFERVIsXG4gICAgICAgICAgICAgICAgICAgIGBCZWFyZXIgJHtpZHBUb2tlbn1gXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBodHRwT3B0aW9ucztcbiAgICB9XG5cbiAgICAvLyBBZGQgd2ViIGFwaSB0b2tlbiBpZiBjYWxsaW5nIHRvIHdhcGkgZG9tYWluLlxuICAgIHByaXZhdGUgYWRkV2ViQXBpVG9rZW4odXJsOiBzdHJpbmcsIGh0dHBPcHRpb25zOiBhbnkgPSB7fSk6IGFueSB7XG4gICAgICAgIGlmICghaHR0cE9wdGlvbnMuaGVhZGVycy5oYXModGhpcy5QRVBQRVJJX1RPS0VOX0hFQURFUikpIHtcbiAgICAgICAgICAgIGNvbnN0IHdhcGlCYXNlVXJsID0gdGhpcy5zZXNzaW9uU2VydmljZS5nZXRXYXBpQmFzZVVybCgpO1xuXG4gICAgICAgICAgICBpZiAod2FwaUJhc2VVcmwgJiYgdXJsLm1hdGNoKG5ldyBSZWdFeHAod2FwaUJhc2VVcmwsICdnJykpKSB7XG4gICAgICAgICAgICAgICAgLy8gVE9ETzpcbiAgICAgICAgICAgICAgICAvLyBjb25zdCB3ZWJBcGlUb2tlbiA9IHRoaXMuc2Vzc2lvblNlcnZpY2UuZ2V0V2FwaVRva2VuKCk7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlclNldHRpbmdDb29raWUgPSB0aGlzLmNvb2tpZVNlcnZpY2UuZ2V0KFxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5QRVBQRVJJX1RPS0VOX0NPT0tJRVxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB3ZWJBcGlUb2tlbiA9IEpTT04ucGFyc2UodXNlclNldHRpbmdDb29raWUpLnZhbHVlc1xuICAgICAgICAgICAgICAgICAgICAgICAgLml0ZW1zW3RoaXMuV0FQSV9UT0tFTl9LRVldO1xuICAgICAgICAgICAgICAgICAgICBpZiAod2ViQXBpVG9rZW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGh0dHBPcHRpb25zLmhlYWRlcnMgPSBodHRwT3B0aW9ucy5oZWFkZXJzLnNldChcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLlBFUFBFUklfVE9LRU5fSEVBREVSLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdlYkFwaVRva2VuXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSBjYXRjaCB7XG4gICAgICAgICAgICAgICAgICAgIC8vIERvIG5vdGhpbmcuXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIGh0dHBPcHRpb25zO1xuICAgIH1cblxuICAgIHByaXZhdGUgc2V0RGVmYXVsdEhlYWRlck9wdGlvbnModXJsOiBzdHJpbmcsIGh0dHBPcHRpb25zOiBhbnkgPSB7fSk6IGFueSB7XG4gICAgICAgIGlmICghaHR0cE9wdGlvbnMuaGVhZGVycykge1xuICAgICAgICAgICAgaHR0cE9wdGlvbnMuaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycygpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gQWRkIGNvbnRlbnQgdHlwZVxuICAgICAgICBpZiAoIWh0dHBPcHRpb25zLmhlYWRlcnMuaGFzKCdDb250ZW50LVR5cGUnKSkge1xuICAgICAgICAgICAgaHR0cE9wdGlvbnMuaGVhZGVycyA9IGh0dHBPcHRpb25zLmhlYWRlcnMuc2V0KFxuICAgICAgICAgICAgICAgICdDb250ZW50LVR5cGUnLFxuICAgICAgICAgICAgICAgICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGh0dHBPcHRpb25zID0gdGhpcy5hZGRBdXRob3JpemF0aW9uVG9rZW4oaHR0cE9wdGlvbnMpO1xuICAgICAgICBodHRwT3B0aW9ucyA9IHRoaXMuYWRkV2ViQXBpVG9rZW4odXJsLCBodHRwT3B0aW9ucyk7XG5cbiAgICAgICAgcmV0dXJuIGh0dHBPcHRpb25zO1xuICAgIH1cblxuICAgIC8vIGdldFRleHRGaWxlKGZpbGVuYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAvLyAgICAgLy8gVGhlIE9ic2VydmFibGUgcmV0dXJuZWQgYnkgZ2V0KCkgaXMgb2YgdHlwZSBPYnNlcnZhYmxlPHN0cmluZz5cbiAgICAvLyAgICAgLy8gYmVjYXVzZSBhIHRleHQgcmVzcG9uc2Ugd2FzIHNwZWNpZmllZC5cbiAgICAvLyAgICAgLy8gVGhlcmUncyBubyBuZWVkIHRvIHBhc3MgYSA8c3RyaW5nPiB0eXBlIHBhcmFtZXRlciB0byBnZXQoKS5cbiAgICAvLyAgICAgLy8gcmV0dXJuIHRoaXMuaHR0cC5nZXQoZmlsZW5hbWUsIHtyZXNwb25zZVR5cGU6ICd0ZXh0J30pXG4gICAgLy8gICAgIC8vICAgICAucGlwZShcbiAgICAvLyAgICAgLy8gICAgICAgICB0YXAoIC8vIExvZyB0aGUgcmVzdWx0IG9yIGVycm9yXG4gICAgLy8gICAgIC8vICAgICAgICAgZGF0YSA9PiB0aGlzLmxvZyhmaWxlbmFtZSwgZGF0YSksXG4gICAgLy8gICAgIC8vICAgICAgICAgZXJyb3IgPT4gdGhpcy5sb2dFcnJvcihmaWxlbmFtZSwgZXJyb3IpXG4gICAgLy8gICAgIC8vICAgICAgICAgKVxuICAgIC8vICAgICAvLyApO1xuICAgIC8vIH1cblxuICAgIGdldEh0dHBDYWxsKHVybDogc3RyaW5nLCBodHRwT3B0aW9uczogYW55ID0ge30pOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBodHRwT3B0aW9ucyA9IHRoaXMuc2V0RGVmYXVsdEhlYWRlck9wdGlvbnModXJsLCBodHRwT3B0aW9ucyk7XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgICAgICAgLmdldCh1cmwsIGh0dHBPcHRpb25zKVxuICAgICAgICAgICAgLnBpcGUoY2F0Y2hFcnJvcih0aGlzLmhhbmRsZUVycm9yLmJpbmQodGhpcykpKTtcbiAgICAgICAgLy8gICAgIC5zdWJzY3JpYmUoXG4gICAgICAgIC8vICAgICAgICAgKHJlcykgPT4gY29uc29sZS5sb2coJycpLFxuICAgICAgICAvLyAgICAgICAgIChlcnJvcikgPT4gY29uc29sZS5sb2coJycpLFxuICAgICAgICAvLyAgICAgICAgICgpID0+IHt9XG4gICAgICAgIC8vICk7XG4gICAgfVxuXG4gICAgcG9zdEh0dHBDYWxsKFxuICAgICAgICB1cmw6IHN0cmluZyxcbiAgICAgICAgYm9keTogYW55IHwgbnVsbCxcbiAgICAgICAgaHR0cE9wdGlvbnM6IGFueSA9IHt9XG4gICAgKTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgaHR0cE9wdGlvbnMgPSB0aGlzLnNldERlZmF1bHRIZWFkZXJPcHRpb25zKHVybCwgaHR0cE9wdGlvbnMpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgICAgICAgIC5wb3N0KHVybCwgYm9keSwgaHR0cE9wdGlvbnMpXG4gICAgICAgICAgICAucGlwZShjYXRjaEVycm9yKHRoaXMuaGFuZGxlRXJyb3IuYmluZCh0aGlzKSkpO1xuICAgICAgICAvLyAgICAgLnN1YnNjcmliZShcbiAgICAgICAgLy8gICAgICAgICAocmVzKSA9PiBjb25zb2xlLmxvZygnJyksXG4gICAgICAgIC8vICAgICAgICAgKGVycm9yKSA9PiBjb25zb2xlLmxvZygnJyksXG4gICAgICAgIC8vICAgICAgICAgKCkgPT4ge31cbiAgICAgICAgLy8gKTtcbiAgICB9XG5cbiAgICBnZXRXYXBpQXBpQ2FsbCh1cmw6IHN0cmluZywgaHR0cE9wdGlvbnM6IGFueSA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3Qgd2FwaUJhc2VVcmwgPSB0aGlzLnNlc3Npb25TZXJ2aWNlLmdldFdhcGlCYXNlVXJsKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEh0dHBDYWxsKGAke3dhcGlCYXNlVXJsfSR7dXJsfWAsIGh0dHBPcHRpb25zKTtcbiAgICB9XG5cbiAgICBwb3N0V2FwaUFwaUNhbGwoXG4gICAgICAgIHVybDogc3RyaW5nLFxuICAgICAgICBib2R5OiBhbnkgfCBudWxsLFxuICAgICAgICBodHRwT3B0aW9uczogYW55ID0ge31cbiAgICApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCB3YXBpQmFzZVVybCA9IHRoaXMuc2Vzc2lvblNlcnZpY2UuZ2V0V2FwaUJhc2VVcmwoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zdEh0dHBDYWxsKGAke3dhcGlCYXNlVXJsfSR7dXJsfWAsIGJvZHksIGh0dHBPcHRpb25zKTtcbiAgICB9XG5cbiAgICBnZXRQYXBpQXBpQ2FsbCh1cmw6IHN0cmluZywgaHR0cE9wdGlvbnM6IGFueSA9IHt9KTogT2JzZXJ2YWJsZTxhbnk+IHtcbiAgICAgICAgY29uc3QgcGFwaUJhc2VVcmwgPSB0aGlzLnNlc3Npb25TZXJ2aWNlLmdldFBhcGlCYXNlVXJsKCk7XG4gICAgICAgIHJldHVybiB0aGlzLmdldEh0dHBDYWxsKGAke3BhcGlCYXNlVXJsfSR7dXJsfWAsIGh0dHBPcHRpb25zKTtcbiAgICB9XG5cbiAgICBwb3N0UGFwaUFwaUNhbGwoXG4gICAgICAgIHVybDogc3RyaW5nLFxuICAgICAgICBib2R5OiBhbnkgfCBudWxsLFxuICAgICAgICBodHRwT3B0aW9uczogYW55ID0ge31cbiAgICApOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgICAgICBjb25zdCBwYXBpQmFzZVVybCA9IHRoaXMuc2Vzc2lvblNlcnZpY2UuZ2V0UGFwaUJhc2VVcmwoKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucG9zdEh0dHBDYWxsKGAke3BhcGlCYXNlVXJsfSR7dXJsfWAsIGJvZHksIGh0dHBPcHRpb25zKTtcbiAgICB9XG59XG4iXX0=